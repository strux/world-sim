<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
	<script type="text/javascript" src="js/phaser.js"></script>
  <script type="text/javascript" src="js/noise.js"></script>
  <script type="text/javascript" src="js/map.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
      #map {
        width: 300px;
        height: 300px;
      }
    </style>
</head>
<body>
<canvas id="map"></canvas>

<script type="text/javascript">

/**************************************************************
* config
**************************************************************/

var cofig,
    textureData,
    TextureFactory,
    bmf,
    BmSprite,
    Map,
    map,
    MapFactroy,
    TileManager,
    tm,
    game,
    debugText = [];

config = {
  tile: {
    width: 16,
    height: 16,
  },
  view: {
    tileWidth: 40,
    tileHeight: 20,
  },
  map: {
    width: 512,
    height: 512,
  }
}

/**************************************************************
* TextureFactory
**************************************************************/
TextureFactory = function(textureData) {
  var bmf = this;
  bmf.textureData = textureData;

  this.textureData.forEach(function(data) {
     bmf.addtextureData(data);
  })
}
TextureFactory.prototype.addtextureData = function(data) {
  textureData = [];
  for(var i=0; i<config.tile.width; i++) {
    textureData[i] = Array(config.tile.height + 1).join(data.paletteKey);
  }
  textureData = data.texture || textureData;
  game.create.texture(data.name, textureData, 2, 2, 0);//, config.tile.width, config.tile.height)
}

/**************************************************************
* TileManager
**************************************************************/

TileManager = function(game, map, tileWidth, tileHeight, width, height) {
  this.game = game;
  this.map = map;
  this.tileWidth = tileWidth;
  this.tileHeight = tileHeight;
  this.viewWidth = width;
  this.viewHeight = height;
  this.startColumn = 0;
  this.startX = 0;
  this.renderCount = 0;
  this.currentTiles = [];
  this.proposedTiles = [];
  this.edgeBuffer = 1;

  Phaser.Group.call(this, this.game);
}
TileManager.prototype = Object.create(Phaser.Group.prototype);
TileManager.prototype.constructor = TileManager;
TileManager.prototype.update = function() {
  this.calculateStartData();
  this.calculateProposedTiles();
  if (this.shouldDrawTiles()) {
    this.renderCount += 1;
    this.removeAll(true, true);

    this.proposedTiles.forEach(function(row) {
      row.forEach(function(tileData) {
        var tile = this.create(tileData.x, tileData.y, this.map[tileData.row][tileData.column]['name']);
        tile.tileData = tileData;
      }, this);
    }, this);
  }
  this.currentTiles = this.proposedTiles;
}
TileManager.prototype.tileDebug = function() {
  var text = '';
  this.proposedTiles[0].forEach(function(tile) {
    text += '[' + tile.row + '][' + tile.column + '] ' + tile.x + ',' + tile.y + '  |  ';
  })
  return text
}
TileManager.prototype.calculateStartData = function() {
  this.startRow = Math.floor(-this.y / this.tileHeight);
  this.startColumn = Math.floor(-this.x / this.tileWidth);
  this.startX = this.tileWidth * this.startColumn;
  this.startY = this.tileHeight * this.startRow;
}
TileManager.prototype.calculateProposedTiles = function() {
  this.proposedTiles = [];
  for(var j=0; j<this.viewHeight + this.edgeBuffer; j++) {
    var row = [],
        y = (this.tileHeight * j) + this.startY,
        viewRow = this.wrappedIndex(this.startRow + j);
    for(var i=0; i<this.viewWidth + this.edgeBuffer; i++) {
      var tile = {
        row: viewRow,
        column: this.wrappedIndex(this.startColumn + i),
        x: (this.tileWidth * i) + this.startX,
        y: y,
      }
      row.push(tile);
    }
    this.proposedTiles.push(row);
  }
}
TileManager.prototype.wrappedIndex = function(index) {
  // XXX: BUG????? this.map.length assuming square map??
  var col;
  if(index < 0) {
    col = index % this.map.length
    if(col < 0) col += this.map.length;
    return col;
  } else if (index >= this.map.length) {
    col = index % this.map.length;
    return col;
  } else {
    return index;
  }
}
TileManager.prototype.shouldDrawTiles = function() {
  return this.currentTiles.length == 0 ||
      (JSON.stringify(this.currentTiles) !== JSON.stringify(this.proposedTiles));
}

game = new Phaser.Game(
        config.view.tileWidth * config.tile.width,
        config.view.tileHeight * config.tile.height,
        Phaser.AUTO,
        'game',
        { preload: preload, create: create, update: update, render:render });

function preload() {
  bmf = new TextureFactory(newMap.elevations);
  tm = new TileManager(game, newMap.tileData, config.tile.width, config.tile.height, config.view.tileWidth, config.view.tileHeight);
}

function create() {
  var playerTexture = [
    '........',
    '..7667..',
    '..6666..',
    '..6666..',
    '.FFFFFF.',
    '..FFFF..',
    '..EEEE..',
    '..E..E..'
  ];
game.create.texture('player', playerTexture, 2, 2, 0);
player = game.add.sprite(game.world.centerX, game.world.centerY, 'player');
player.anchor.set(0.5);
}

function update() {
  if (game.input.keyboard.isDown(Phaser.Keyboard.LEFT)) {
    tm.x += 4;
  }
  if (game.input.keyboard.isDown(Phaser.Keyboard.RIGHT)) {
    tm.x -= 4;
  }
  if (game.input.keyboard.isDown(Phaser.Keyboard.UP)) {
    tm.y += 4;
  }
  if (game.input.keyboard.isDown(Phaser.Keyboard.DOWN)) {
    tm.y -= 4;
  }
}

function render() {
  return
  game.debug.text(debugText[0], 12, 128);
  game.debug.text(debugText[1], 12, 160);
  game.debug.text(debugText[2], 12, 192);
}

var seed = Math.random(),
    newMap = new Map(config.map.width, config.map.height, seed, config.tile.width, config.tile.height);
newMap.writeTileData();
var canvas = document.getElementsByTagName('canvas')[0];
canvas.width = config.map.width;
canvas.height = config.map.height;
var ctx = canvas.getContext('2d'),
    seed = Math.random(),
    image = ctx.createImageData(canvas.width, canvas.height),
image = newMap.writeImageData(image);
ctx.putImageData(image, 0, 0);
</script>

</body>
</html>
